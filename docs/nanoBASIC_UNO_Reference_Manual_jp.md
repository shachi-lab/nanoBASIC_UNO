# 📘**nanoBASIC UNO リファレンスマニュアル**

日本語版
Version 0.15 対応

## 概要
Arduino UNO 上で動作（ATmega328P）上で動作するBASICインタプリターです。  
入力された命令文を中間言語（バイトコード）に翻訳し、インタプリター方式で処理を実行します。

* 行番号はラベルとして扱う（順序とは無関係）
* コードは中間コード化して1行ごとに63バイト以内
* 再帰を使わない手書きの式パーサ
* プログラム領域はRAM上に置き、PROGで直接書き込む
* プログラムをEEPROMに保存可能
* REPL / Run の 動作モード

---

## 動作モード
動作モードには、「REPLモード」と「Runモード」があります。  
* **REPLモード**  
  シリアルポートからの入力文字列を命令文として、１行毎にインタラクティブにコマンドを実行します。
* **Runモード**  
  プログラム領域に保存されたプログラムを順次実行します。  

nanoBASIC UNO の起動直後は REPLモード です。

---

## 入力
コマンド等はシリアルポートから入力します。
ステートメントは大文字、小文字を区別しません。
ただし、コメントおよび文字列中の内容は入力されたとおりとなります。

---

## 数値
NanoBASIC の数値はすべて 16bit 整数（-32768〜32767）です。  
floatなどの浮動小数点はありません。
演算によるオーバーフローは考慮しません。
デフォルトの数値は10進数です。  
数値の前に「＄」をつけると16進数となります。
```
A=10
B=$BEEF
```

---

## 変数
* 変数 ： A ～ Zまでの26個　（符号付16ビット整数）
* 配列変数 ： @[index] で表される１次元配列が１つ（符号付16ビット整数、indexの範囲は0～63）

すべてグローバル変数です。  
ローカル変数はありません。
文字列変数はありません。

---

## 演算子
式には、以下の演算子が使用可能です。

### 二項演算子  
|演算子 |意味 |
|:---:|-----|
|\+ | 加算|
|\- | 減算|
|\* | 乗算|
|\/ | 除算|
|\%  | 剰余|

### 単項演算子
|演算子 |意味 |
|:---:|-----|
|- | 符号反転 |
|~ | ビット反転|
|! | 否定(NOT)|

### 論理演算子
|演算子 |意味 |
|:---:|-----|
|&& | 論理積 (AND)|
|\|\| | 論理輪 (OR)|

### ビット演算子
|演算子 |意味 |
|:---:|-----|
|& | ビット単位の論理積 (AND)|
|\| | ビット単位の論理輪 (OR)|
|^ | ビット単位の排他的論理輪(XOR)|

### シフト演算子
|演算子 |意味 |
|:---:|-----|
|<< | 左シフト|
|>> | 右シフト|

### 比較演算子
|演算子 |意味 |
|:---:|-----|
|=  | 一致|
|<> | 不一致|
|<  | 未満|
|<= | 以下|
|>  | 超過|
|>= | 以上|

### 括弧
|演算子 |意味 |
|:---:|-----|
|(式) | 括弧の内側を優先して演算|

---

## 式
数値および演算子を使用したものを「式」とします。
式は、数値、変数、演算子を使って記述します。
コマンドの引数や代入文に、式の記述が可能です。
基本的な優先度に従って演算されます。

---

## 代入文
「変数 = 式」
変数名に続けて「＝」の後に式を記述すると、式の演算結果が変数に代入されます。
LETコマンドはありませ。
```
A=10
```
---

## 複合代入演算子
変数への代入には、以下の複合代入演算子が使用できます。  
+=、 =、 *=、 /=、 %=、 |=、 &=、 ^= 、 <<=、 >>=
変数の数値と演算子で演算した結果を変数に代入します。
```
A+=10+B
A<<=1
```

---

## インクリメント、デクリメント
変数に続けて、"++" または、"--" を記述すると、  
変数の内容を インクリメント(+1) または、デクリメント(-1) します。  
※ 式の中には記述できません。 単独でのみ使用可能です。 
```
A++
@[10]--
```

---

## 命令文
命令文は、1つ以上のコマンドまたは代入文です。
コマンドや代入文を「：」でつなげてマルチステートメントにすることができます。
ただし、１行は63文字または、バイトコードに変換したときに63バイト以下にしてください。

---

## ラベル番号
プログラムの GOTOやGOSUBなどの分岐先を示すもので、プログラム各行の行頭につける番号です。
ラベル番号は行頭のみ、1～32768 までの値を設定できます。
プログラム中に同一のラベル番号が存在してもエラーにはならなりませんが、プログラムの先頭に近いほうが有効となります。
また、ラベル番号は必須ではありませんので、ラベル番号が必要な行のみにつけてください。
ラベル番号の値とプログラムの実行順に関連はありません。

---

## 行番号
行番号は、プログラムの最初から何行目かを表す数値です。
行番号(line number)とラベル番号は別物です。
したがって、GOTO、GOSUB 等での飛び先には使用できません。

---

## 動作の中断
端末からシリアルポートに「Ctrl-C(0x03)」を送信することによって、プログラムの動作を中断することができます。
中断したプログラム動作はRESUMEコマンドで中断箇所から再開することができます。
ただし、エラー等で処理が中断した場合はRESUMEコマンドでの再開はできません。

---

## 入れ子
GOSUB～RETURN、FOR～NEXT、DO～LOOP、WHILE～LOOPの入れ子のスタックはすべて共通です。
スタックの深さは８段階です。
入れ子が８段階を超ええると、スタックオーバーフローエラーとなります。

---

## コメント
「'」以降の内容が行末までコメントとなります。
（コマンドの後ろに記述するときは、「：」の後に記述してください。）

---

## コマンド
命令文には以下のコマンドが使用できます。

### PRINT
書式：PRINT 文字列式  

PRINTの代わりに "?" での代用が可能です。  
数値，文字列を出力します。
文字列式には１つまたは複数の式または文字列を指定できます。
複数の式、文字列はコンマやセミコロンで区切って指定します。
コンマで区切るとタブ出力になり、セミコロンで区切ると続けて出力します。
文字列と式との間はセミコロンの省略が可能です。
文字列式の最後をセミコロンで終了すると改行を出力しません。
PRINT文中でのみ、文字列、CHR関数、文字列化指定が利用できます。

### INPUT  
書式：INPUT 変数名  

シリアルポートからの入力を待ち、入力された数値を変数に格納します。
入力する数値の先頭が＄の場合は、16進数として扱います。
変数名の後ろに＄をつけると、入力された１文字目のASCIIコードを変数に格納します。

### GOTO
書式：GOTO 式  

式で指定されたラベル番号にジャンプします。
※ 式は数値リテラルから始まる必要があります。

### GOSUB  
書式：GOSUB 式  

式で指定されたラベル番号のサブルーチンにジャンプします。
サブルーチン内のRETURNコマンドにより、本コマンドの次の命令文に戻ります。
※ 式は数値リテラルから始まる必要があります。

### RETURN
書式：RETURN  

サブルーチンから戻ります。

### IF,THEN,ELSEIF,ELSE,ENDIF
書式：IF 式 THEN 命令文 ELSEIF 式 THEN 命令文 ELSE 命令文 ENDIF

条件によって実行する命令文に制御を移します。
ELSEIF、ELSE は省略できます。（IFの後には、THENとENDIFが必須です）
THEN、ELSE 直後に式を記載すると、GOTO と同様の動作となります。
式の演算結果が０の場合は「偽」、０以外の場合は「真」となります。

### FOR,TO,STEP,NEXT
書式：FOR 変数名=式１ TO 式２ STEP 式３ ～ NEXT

変数名に式１を代入した後、変数が式２になるまでNEXTとの間をループします。
プログラムがNEXTに来る毎に、変数に式３の値が加算されます。
STEP 式３は省略可能で、省略された場合は１が指定されたことになります。

### DO,LOOP
書式： DO ～ LOOP

DO～LOOP を繰り返します

### DO,LOOP WHILE
書式：DO ～ LOOP WHILE 式

式の結果が「真」のとき、DO～LOOP WHILEを繰り返します。
DO～LOOP間を実行した後に式の判定をして、真のときに繰り返します。

### WHILE,LOOP
書式：WHILE 式 ～ LOOP

式の結果が「真」のとき、WHILE～LOOPを繰り返します。
式の判定をした後、真のときにWHILE～LOOP間を繰り返します。

### EXIT
書式：EXIT

FOR～NEXT、DO/WHILE～LOOPの繰り返し処理から抜け出ます。
NEXTまたはLOOP(LOOP WHILE)の直後の命令文に処理を移します。

### CONTINUE
書式：CONTINUE

FOR～NEXT、DO/WHILE～LOOPの処理をスキップさせ再び繰り返し処理の初めから実行します。
NEXTまたはLOOP(LOOP WHILE)の処理に移ります。

### END
書式：END

プログラムの実行を終了して、REPLモードに戻ります。　
REPL モードで実行すると、入れ子のスタックおよびプログラムの中断状態を初期化します。

### STOP
書式：STOP

プログラムの実行を中断します。
RESUMEでの再開が可能です。

### RESUME
書式：RESUME

STOP または、シリアルポートからの Ctrl-C 受信で中断した処理を再開します。
エラーによる中断は再開できません。

### DELAY
書式：DELAY 式

式で指定した時間だけ待ちます。
単位は1msecです。

### PAUSE
書式：PAUSE

シリアルポートから１文字が入力されるまで待ちます。

### DATA
書式：DATA　式１、式２・・・

READコマンドで読み込む数値を記載します。（数値だけでなく、式も記述可能です。）
複数の式をカンマで区切って記述します。

### READ
書式：READ 変数

DATAコマンドで記載された式の数値を、変数に読み込みます。
READコマンドを実行するたびに、DATAコマンドでの記載順に読み込まれます。
読み込むDATAが無くなってからREADするとエラーとなります。

### RESTORE
書式：RESTORE

READコマンドで読み込むDATAコマンドの順番を、プログラムの先頭に戻します。

### RESET
書式：RESET

システムリセットを実行します。

### NEW
書式：NEW

プログラム領域に書きこまれたプログラムを削除します。

### PROG
書式：PROG

プログラム領域にプログラムを書き込みます。
「＞」の表示に続けて、書き込むプログラムを１行ごとに入力します。
行頭が「＃」の行を入力すると、書き込みモードを終了します。
なお、インデントや不要なスペース等は無視され、コメントと文字列以外はすべて大文字になります。
また、バイトコードへの変換時に文法エラー等があった場合は、その行はプログラム領域書き込まれずに
エラーを出力しますが、書き込みモードは終了せずに次行の入力となります。

##### 注意事項
* 入力１行毎にバイトコードへの変換が行われるので、連続して行を入力する場合は、変換に必要な時間を考慮して、行間に100ms程度のウエイトを入れてください。  
* プログラム領域はRAM上にあるため、リセットや電源OFFによって消去されます。  
* SAVE / LOAD コマンドで、EEPROMへの保存と読み込みが可能です。

入力例：
```
PROG
>DO
>OUTP 13, 1
>DELAY 200
>OUTP 13, 0
>DELAY 200
>LOOP
>#
OK
RUN
```

### RUN
書式：RUN

Runモード になり、プログラム領域にあるプログラムを先頭から実行します。
実行に先立って、各変数は０にクリアされます。
プログラムエリアのプログラムの実行が終了および中断すると  
REPLモードに戻ります。

### LIST
書式：LIST

プログラム領域に書き込まれたプログラムを出力します。

### SAVE
書式：SAVE [引数]

プログラムエリアの内容をEEPROMへ保存または消去します。  
EEPROMに保存したプログラムはリセット、電源断によっても消去されません。  
また、自動実行に設定することもできます。  
EEPROMに保存したプログラムは、LOADコマンドで読み出しが可能です。  

- **通常保存**（引数なし）  
プログラムエリアの内容をEEPROMへ保存します。  
プログラムエリアが空の場合はエラー（誤操作防止のため）となります。  
AutoRun は無効になります。
- **AutoRun保存** （引数：`!`）
通常保存に加えて、AutoRun を有効にして保存します。
AutoRun が有効の場合は、電源投入時に LOAD 後に自動実行されます。
- **消去**（引数：`0`）
EEPROMに保存されているプログラムを消去します。
プログラムエリアの内容には影響しなません、
AutoRunmは無効になります。

### LOAD
書式：LOAD

EEPROMに保存されたているプログラムを、プログラムエリアに読み込みます。  
プログラムエリアにある既存プログラムと置き換わります。
EEPROMにプログラムが無いときはエラーとなります。

### RANDOMIZE
書式：RONDOMIZE　式

式で与えられた値で、乱数の種を設定します。

### OUTP
書式：OUTP　式１，式２

GPIOポートに出力します。
式１にはピン番号を指定します。（下表以外のピン番号はエラーになります）
式２に０を指定するとLow、０以外を指定するとHighを出力します。
|Pin|Function|
|----|----|
|0-7 |PORTD|
|8-13|PORTB|
### PWM
書式：PWM  式１，式２

ポートにPWMを出力します。
式１にはピン番号を指定します。（下表以外のピン番号はエラーになります）
式２にはデューティ比（0から255）を指定します。  
※ Arduino UNO の analogWrite() を利用しているため、デューティ比は 0〜255 の8bit精度です。
|Pin|Function|
|----|----|
|3,5,6,9,10,11|PWM|

---

## 関数

演算式には、関数を使用することができます。

### RND
書式：RND(式)

式を超えない値の乱数が戻ります。

### ABS
書式：ABS(式)

式の絶対値が戻ります

### INP
書式：INP(式)

GPIOから入力します。
式にはピン番号を指定します。（下表以外のピン番号はエラーになります）
ポートの状態がLowのときは０，Highのときは１が戻ります。
|Pin|Function|
|----|----|
|0-7 |PORTD|
|8-13|PORTB|

## ADC
書式：ADC(式)

アナログポートから入力します。
式にはADC番号を指定します。（下表以外のADC番号はエラーになります）
ADコンバーターからの0から1023までの整数値が戻ります。
|ADC|Function|
|----|----|
|0-5|ADC|

### CHR
書式：CHR(式)

PRINTコマンドの引数内でのみ有効な関数です。
式のASCIIコード文字を出力します。

### 文字列化関数

書式（10進数）：0(式、桁数)
書式（16進数）：$(式、桁数)

PRINTコマンドの引数内でのみ有効な関数です。
文字列化の指定に従って、式の数値を出力します。
この関数を使用することで、任意の桁数や16進数で出力することができます。

式には文字列化する数値を指定します。
桁数には以下を指定します。
* = 0 ： 桁数自動（デフォルト）  
* \> 0 ： 指定し桁数で、リーディングスペース  
* < 0 ： 桁数は絶対値の値、リーディングゼロ  

例：
```
　$(1234,4)   -> [ 4D2]
　$(1234,-4)  -> [04D2]
　0(1234,5)   -> [ 1234]
　0(-1234,-6) -> [-01234]
　0(-1234,0)  -> [-1234]
```

---

## 予約変数・定数
nanoBASIC UNO にはシステムの予約変数があります。

### TICK
システムのクロックカウント値（約1msec毎にインクリメント）です。

### INKEY
シリアルポートからの入力された文字のASCIIコードです。
入力がない場合は０となります。

---

## AutoRun 機能
NanoBASIC UNO には、電源投入時に EEPROM に保存されたプログラムを
自動実行できる AutoRun 機能があります。

AutoRun は SAVE コマンドの引数で指定する方式で、特別な設定コマンドは不要です。
スタンドアロン動作や組み込み用途に便利な機能です。

AutoRun が有効な場合、電源投入またはリセット後に約3秒待機し、
その後 自動的に LOAD → RUN が実行されます。

この 3 秒間に Ctrl-C を入力すると、AutoRun を中断して REPL モードに戻ります。

---

## エラーメッセージ
エラーが発生したときは、以下のエラーメッセージを表示して処理を中止します。
プログラムモードのときは、エラーが発生した行の行番号も表示します。

* **Syntax error :**
文法エラーです。認識できない命令文や記述ミスがあります。

* **Division by 0 error :**
０で除算しました。

* **Array index over error :**
配列の添え字の範囲が負数または255を超えています。

* **Parameter error :**
パラメーターが必要なコマンドにパラメーターが指定されていません。  
または、パラメーターの範囲が不正です。

* **Stack overflow error :**
スタックがオーバーしました。  
GOSUB,FOR,DO,WHILE の入れ子が８段を超えたました。

* **Can't resume error :**
プログラムを RESUMEコマンドで再開できません。
処理がエラーで中止されたときは再開ができません。

* **Label not found error :**
GOTO,GOSUBの指定先のラベル番号が見つかりませんでした。

* **Unless from run-mode error :**
Runモードでは実行できないコマンドです。
PROG,SAVE,LOAD,NEW,LIST,RUN,RESUMEコマンドは、Runモードで実行できません。

* **PG area overflow error :**
PROGコマンドのプログラム書き込みで、プログラムエリアの容量がオーバーしました。

* **PG empty error :**
SVAEコマンド または LOADコマンドで、プログラムがありませんでした。

* **Loop nothing error :**
DO/WHILEコマンドで、対応するLOOPがありません。

* **Endif not found error :**
IFに対応するENDIFがありません。

* **Unexpected Next error :**
NEXTに対応するFORコマンドがありません。

* **Unexpected Return error :**
RETURNに対応するGOSUBがありません。

* **Unexpected Loop error :**
LOOPに対応するDO/WHILEがありません。

* **Unexpected Exit error :**
EXITに対応するFORまたはDO/WHILEがありません。

* **Unexpected Continue error :**	
CONTINUEに対応するFORまたはDO/WHILEがありません。
